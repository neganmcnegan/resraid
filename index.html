<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reservoir Raid Deployment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans:wght@400;600;800&family=Noto+Sans+SC:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans', 'Noto Sans SC', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            overflow-x: hidden;
            user-select: none;
            overscroll-behavior-y: contain;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .map-viewport {
            width: 100%;
            max-width: 1000px;
            height: 600px;
            overflow: hidden; 
            border-radius: 1.5rem;
            /* Infinite desert feel */
            background-image: url('img/reservoir bg.png');
            background-size: cover;
            border: 4px solid #ffffff;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            cursor: grab;
            position: relative;
            margin: 0 auto;
            touch-action: pan-y pinch-zoom;
        }

        .map-container {
            position: absolute;
            width: 1000px; 
            height: 800px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: 0 0;
            will-change: transform;
        }

        .map-container.is-panning { transition: none; }

        .building {
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; 
            gap: 2px;
        }

        .building > * { pointer-events: auto; }

        .building-img {
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
            pointer-events: none;
            z-index: 5;
            display: block;
        }

        .building-label {
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 8px;
            margin-bottom: 4px;
            white-space: nowrap;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 20;
        }

        .player-bubble {
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin: 1px 0;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            min-width: 110px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border-width: 1px;
            position: relative;
            background-color: white;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-mode .player-bubble:hover { border-color: #6366f1; transform: scale(1.05); z-index: 30; }

        .search-highlight {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.4) !important;
            transform: scale(1.2);
            z-index: 50;
            background-color: #ffffff !important;
            color: #6366f1 !important;
        }

        .color-default { background-color: #f1f5f9; border-color: #e2e8f0; color: #64748b; }
        .color-center { background-color: #fee2e2; border-color: #fecaca; color: #b91c1c; } 
        .color-dev { background-color: #dcfce7; border-color: #bbf7d0; color: #15803d; }   
        .color-munition { background-color: #fef9c3; border-color: #fef08a; color: #a16207; }

        @media (max-width: 768px) {
            .low-zoom .player-bubble span { display: none; }
            .low-zoom .building-label { display: none; }
            .low-zoom .building-img { width: 45px !important; height: 45px !important; }
            .low-zoom .player-bubble { min-width: 14px; width: 14px; height: 14px; padding: 0; border-radius: 50%; border-width: 2px; }
        }

        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 80;
        }

        .ctrl-btn {
            width: 44px; height: 44px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; color: #6366f1;
        }

        #search-banner-container {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 1rem;
        }

        .btn-active { background-color: #4f46e5 !important; color: white !important; }
        .btn-inactive { color: #475569 !important; background-color: white !important; border: 1px solid #e2e8f0 !important; }

        .loading-overlay {
            position: fixed; inset: 0; background: #ffffff; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s;
        }

        .pc-hint-overlay, .mobile-hint-overlay {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 90; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); cursor: pointer;
            transition: opacity 0.5s ease;
        }

        /* Search bar pulse animation in RED */
        .search-pulse { animation: pulse-ring-red 1.5s infinite; }
        @keyframes pulse-ring-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .search-tooltip {
            position: absolute; top: 110%; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 10px 16px; border-radius: 12px;
            font-size: 11px; font-weight: 800; white-space: nowrap; z-index: 100;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); pointer-events: none;
        }
        .search-tooltip::after {
            content: ''; position: absolute; bottom: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: transparent transparent #ef4444 transparent;
        }

        .search-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
            max-height: 260px;
            overflow-y: auto;
            z-index: 120;
        }

        .search-item {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            background: white;
        }

        .search-item:hover {
            background: #eef2ff;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Loading Screen -->
    <div id="loader" class="loading-overlay">
        <div class="text-indigo-600 animate-bounce font-black text-4xl mb-2 italic uppercase tracking-tighter">Raid Planner</div>
        <div class="text-slate-400 text-[10px] uppercase tracking-[0.3em] font-bold">Synchronizing Tactics</div>
    </div>

    <div class="max-w-[1100px] mx-auto main-content">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4 w-full">
            <div>
                <h1 class="text-3xl font-black tracking-tight text-slate-900">Reservoir Raid <span class="text-indigo-600">Planner</span></h1>
                <div class="flex items-center gap-4 mt-1">
                    <p id="sub-header" class="text-slate-500 text-sm font-medium" data-i18n="sub-header">Tactical Deployment System</p>
                    <button id="admin-link" onclick="openAdminModal()" class="text-[10px] text-slate-400 hover:text-indigo-600 transition-colors uppercase tracking-widest font-bold" data-i18n="admin-only">(Richard Only)</button>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                <div class="relative w-full md:w-64" id="search-container">
                    <input type="text" id="player-search" data-i18n-placeholder="search-placeholder" placeholder="Search your name..." class="w-full bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-red-100 transition-all shadow-sm" oninput="handleSearchInput()">
                    <span class="absolute right-3 top-2.5 opacity-30 text-xs">üîç</span>
                    <div id="search-tip" class="search-tooltip hidden" data-i18n="hint-search">Search your name for full instructions</div>
                    <div id="search-dropdown" class="search-dropdown hidden"></div>
                </div>
                <div class="flex gap-1 bg-white p-1 rounded-xl shadow-sm border border-slate-200 text-[10px] overflow-x-auto max-w-full">
                    <button onclick="setLang('en')" class="px-2 py-1 rounded-lg hover:bg-slate-50 font-bold">EN</button>
                    <button onclick="setLang('pt')" class="px-2 py-1 rounded-lg hover:bg-slate-50 font-bold">PT</button>
                    <button onclick="setLang('es')" class="px-2 py-1 rounded-lg hover:bg-slate-50 font-bold">ES</button>
                    <button onclick="setLang('fr')" class="px-2 py-1 rounded-lg hover:bg-slate-50 font-bold">FR</button>
                    <button onclick="setLang('zh')" class="px-2 py-1 rounded-lg hover:bg-slate-50 font-bold">ZH</button>
                    <button onclick="setLang('ru')" class="px-2 py-1 rounded-lg hover:bg-slate-50 font-bold">RU</button>
                </div>
            </div>
        </div>

        <div id="search-banner-container">
            <div id="search-banner" class="hidden w-full bg-indigo-600 text-white p-6 rounded-3xl shadow-xl text-center font-bold text-sm leading-relaxed border-4 border-indigo-400 max-w-3xl animate-in fade-in zoom-in duration-300"></div>
        </div>

        <!-- Controls -->
        <div class="flex flex-wrap gap-4 mb-6 w-full">
            <div class="flex bg-white rounded-2xl p-1 shadow-sm border border-slate-200">
                <button id="btn-phase1" onclick="setPhase(1)" class="px-6 py-2 rounded-xl text-xs font-black transition-all btn-active" data-i18n="phase1">PHASE 1: START</button>
                <div class="relative">
                    <button id="btn-phase2" onclick="setPhase(2)" class="px-6 py-2 rounded-xl text-xs font-black transition-all btn-inactive" data-i18n="phase2">PHASE 2: 10M+</button>
                    <span id="phase2-dot" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                </div>
            </div>
            
            <div id="admin-toggle" class="hidden flex bg-indigo-50 rounded-2xl p-1 shadow-sm border border-indigo-200">
                <button id="btn-view-map" onclick="setView('map')" class="px-6 py-2 rounded-xl text-xs font-black btn-active shadow-sm" data-i18n="view-map">MAP VIEW</button>
                <button id="btn-view-admin" onclick="setView('admin')" class="px-6 py-2 rounded-xl text-xs font-black btn-inactive" data-i18n="view-admin">ADMIN</button>
            </div>
        </div>

        <!-- MAP VIEW -->
        <div id="view-map" class="block w-full">
            <div class="map-viewport" id="viewport">
                <!-- Mobile Hint -->
                <div id="mobile-hint" class="mobile-hint-overlay hidden" onclick="dismissHint()">
                    <div class="bg-white p-8 rounded-[2.5rem] text-center shadow-2xl max-w-[85%] border border-indigo-100">
                        <span class="text-5xl mb-4 block animate-bounce">üëâüëà</span>
                        <p class="font-black text-indigo-600 uppercase text-sm tracking-widest mb-2" data-i18n="hint-mobile">Use two fingers to move the map</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-8" data-i18n="hint-search">Search your name for full instructions</p>
                        <button class="w-full bg-indigo-600 text-white px-6 py-4 rounded-2xl font-black uppercase text-xs shadow-xl shadow-indigo-200 active:scale-95 transition-transform" data-i18n="got-it">Got it</button>
                    </div>
                </div>
                <!-- PC Hint -->
                <div id="pc-hint" class="pc-hint-overlay hidden md:flex" onclick="dismissHint()">
                    <div class="bg-white p-10 rounded-[2.5rem] text-center shadow-2xl border border-indigo-100 max-w-sm">
                        <span class="text-4xl mb-4 block">üìã</span>
                        <p class="font-black text-indigo-600 uppercase text-xs tracking-widest mb-8" data-i18n="hint-search">Search your name for full instructions</p>
                        <button class="w-full bg-indigo-600 text-white px-6 py-3 rounded-2xl font-black uppercase text-xs shadow-lg active:scale-95 transition-transform" data-i18n="got-it">Got it</button>
                    </div>
                </div>

                <div class="map-container" id="map-root"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 w-full">
                <div id="joker-section" class="bg-white p-4 rounded-2xl border border-amber-100 shadow-sm border-l-4 border-l-amber-400">
                    <h3 class="text-amber-600 font-black mb-1 text-sm flex items-center gap-2 uppercase tracking-wide">
                        <span>üÉè</span> <span data-i18n="jokers">Jokers</span>
                    </h3>
                    <p class="text-xs text-slate-600 leading-relaxed font-medium" data-i18n="joker-desc">if center is secure, go look for water tanks when they start spawning or offering help throughout the map where it's needed. if not, then help fight for center.</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-indigo-100 shadow-sm border-l-4 border-l-indigo-400">
                    <h3 class="text-indigo-600 font-black mb-1 text-sm flex items-center gap-2 uppercase tracking-wide">
                        <span>üîÑ</span> <span data-i18n="movement">Phase Movement</span>
                    </h3>
                    <p class="text-xs text-slate-600 leading-relaxed font-medium" data-i18n="movement-desc">Red/Green/Yellow bubbles show players moving to key buildings as soon as they are available.</p>
                </div>
            </div>
        </div>

        <!-- ADMIN VIEW -->
        <div id="view-admin" class="hidden space-y-6 w-full">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-black mb-4 text-slate-800">Static Data Update</h2>
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-4">Paste your player list here (Name, Power) to update local state.</p>
                    <textarea id="player-input" class="w-full h-48 bg-slate-50 border border-slate-200 rounded-2xl p-4 text-slate-700 font-mono text-sm mb-4 outline-none focus:ring-2 focus:ring-indigo-100" placeholder="Name, Power&#10;Richard, 10000"></textarea>
                    <button onclick="processPlayers()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl transition-all shadow-lg mb-4">Update Local Roster</button>
                    <button onclick="exportData()" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-3 rounded-xl text-xs">üìã COPY CODE FOR UPDATING FILE</button>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                        <h2 class="text-lg font-black text-slate-800">Alliance Database</h2>
                        <div class="flex flex-wrap items-center gap-3">
                            <label for="admin-sort" class="text-[10px] uppercase tracking-widest font-bold text-slate-400">Sort</label>
                            <select id="admin-sort" onchange="setSortMode(this.value)" class="bg-slate-50 text-[10px] font-bold border border-slate-200 rounded-lg px-2 py-1 outline-none">
                                <option value="power">Power</option>
                                <option value="alpha">Name (A-Z)</option>
                                <option value="updated">Last Updated</option>
                            </select>
                            <button onclick="clearAll()" class="text-xs text-red-400 font-bold hover:underline">Wipe All</button>
                        </div>
                    </div>
                    <div id="roster-list" class="space-y-1 max-h-[500px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zoom Controls -->
    <div class="zoom-controls">
        <button class="ctrl-btn" onclick="adjustZoom(0.25)">+</button>
        <button class="ctrl-btn" onclick="adjustZoom(-0.25)">‚àí</button>
    </div>

    <!-- Language Modal -->
    <div id="lang-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden items-center justify-center p-4 z-[400]">
        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-md border border-slate-200 shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-1 text-slate-900">Select Language</h2>
            <p class="text-slate-400 text-[10px] uppercase tracking-widest font-bold mb-8">Escolha seu idioma / Seleccionar idioma</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="setLangAndClose('en')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-100 p-4 rounded-2xl font-black text-slate-700">English</button>
                <button onclick="setLangAndClose('pt')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-100 p-4 rounded-2xl font-black text-slate-700">Portugu√™s</button>
                <button onclick="setLangAndClose('es')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-100 p-4 rounded-2xl font-black text-slate-700">Espa√±ol</button>
                <button onclick="setLangAndClose('fr')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-100 p-4 rounded-2xl font-black text-slate-700">Fran√ßais</button>
                <button onclick="setLangAndClose('zh')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-100 p-4 rounded-2xl font-black text-slate-700">&#x4E2D;&#x6587;</button>
                <button onclick="setLangAndClose('ru')" class="bg-slate-50 hover:bg-indigo-50 border border-slate-100 p-4 rounded-2xl font-black text-slate-700">&#x0420;&#x0443;&#x0441;&#x0441;&#x043A;&#x0438;&#x0439;</button>
            </div>
        </div>
    </div>

    <!-- Replace/Swap Modal -->
    <div id="replace-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-[300]">
        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-md border border-slate-200 shadow-2xl">
            <h2 class="text-2xl font-black mb-2 text-slate-800"><span id="replace-target" class="text-indigo-600"></span></h2>
            <p class="text-[10px] text-slate-400 mb-6 italic uppercase tracking-widest font-bold">Tactical Commander Controls</p>

            <div id="modal-sort-row" class="hidden items-center justify-between gap-3 mb-4">
                <label for="modal-sort" class="text-[10px] uppercase tracking-widest font-bold text-slate-400">Sort</label>
                <select id="modal-sort" onchange="setSortMode(this.value)" class="bg-slate-50 text-[10px] font-bold border border-slate-200 rounded-lg px-2 py-1 outline-none">
                    <option value="power">Power</option>
                    <option value="alpha">Name (A-Z)</option>
                    <option value="updated">Last Updated</option>
                </select>
            </div>
            
            <div id="modal-menu" class="space-y-3 mb-6">
                <button onclick="showSwapList()" class="w-full bg-slate-50 hover:bg-indigo-50 p-4 rounded-2xl text-left flex items-center justify-between border border-slate-100 transition-colors">
                    <span class="font-bold text-slate-700">üîÑ Swap with Active Player</span>
                    <span class="text-indigo-400 font-black">‚Üí</span>
                </button>
                <button onclick="moveCurrentToBench()" class="w-full bg-slate-50 hover:bg-amber-50 p-4 rounded-2xl text-left flex items-center justify-between border border-slate-100 transition-colors">
                    <span class="font-bold text-slate-700">üì• Move to Bench</span>
                    <span class="text-amber-500 font-black">‚Üí</span>
                </button>
                <button onclick="showReplaceWithBench()" class="w-full bg-indigo-50 hover:bg-indigo-100 p-4 rounded-2xl text-left border border-indigo-100 flex items-center justify-between transition-colors">
                    <span class="font-bold text-indigo-700">‚≠ê Replace with Reserve</span>
                    <span class="text-indigo-500 font-black">‚Üí</span>
                </button>
            </div>

            <div id="bench-options" class="hidden space-y-2 max-h-80 overflow-y-auto mb-6 pr-2"></div>
            
            <button onclick="closeReplaceModal()" class="w-full py-2 text-slate-400 font-bold hover:text-slate-600">Cancel</button>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-[200]">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm border border-slate-200 shadow-2xl">
            <h2 class="text-xl font-black mb-6 text-slate-800 flex items-center gap-3">üîê Richard's Access</h2>
            <input type="password" id="admin-pass-input" class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-slate-800 mb-6 outline-none focus:ring-2 focus:ring-indigo-100" placeholder="Enter Password">
            <div class="flex gap-4">
                <button onclick="closeAdminModal()" class="flex-1 py-3 text-slate-400 font-bold hover:text-slate-600">Cancel</button>
                <button onclick="checkAdminPass()" class="flex-1 bg-indigo-600 text-white font-black py-3 rounded-2xl">Login</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
const INITIAL_DATA = [{"name":"Missifoo","power":35079,"tacticalRank":35079,"id":1768696641001.4856,"status":"team","updatedAt":1768704361176},{"name":"Gokturk","power":8628,"tacticalRank":9860,"id":1768696641001.3098,"status":"team","updatedAt":1768707246087},{"name":"Richard Gansey","power":10704,"tacticalRank":7465,"id":1768696641001.9663,"status":"team","updatedAt":1768705843536},{"name":"Jackie Ouyang","power":26508,"tacticalRank":26508,"id":1768696641001.905,"status":"team","updatedAt":1768704361179},{"name":"Rich","power":5817,"tacticalRank":6245,"id":1768696641001.94,"status":"team","updatedAt":1768704916858},{"name":"Brewster","power":6100,"tacticalRank":6100,"id":1768696641001.336,"status":"team","updatedAt":1768704361181},{"name":"Atilla","power":15190,"tacticalRank":10070,"id":1768696641001.6313,"status":"team","updatedAt":1768706205415},{"name":"Atomic","power":6482,"tacticalRank":8628,"id":1768696641001.9788,"status":"team","updatedAt":1768708376696},{"id":1768704326842.4817,"name":"–î–∞—Ä–∏—è","power":6858,"tacticalRank":3712,"status":"bench","updatedAt":1768760213952},{"name":"xXProfessoRXx","power":8821,"tacticalRank":8821,"id":1768696641001.5781,"status":"team","updatedAt":1768704361185},{"name":"CraterFace","power":9220,"tacticalRank":8562,"id":1768696641001.473,"status":"team","updatedAt":1768706408557},{"name":"fukyouall","power":3377,"tacticalRank":5817,"id":1768696641001.214,"status":"team","updatedAt":1768705649543},{"name":"lilvice89","power":8562,"tacticalRank":5225,"id":1768696641001.6907,"status":"team","updatedAt":1768708376696},{"name":"TinyTot","power":12503,"tacticalRank":12503,"id":1768696641001.0212,"status":"team","updatedAt":1768704361189},{"name":"GravyBoatGoat","power":6157,"tacticalRank":6482,"id":1768696641001.7002,"status":"team","updatedAt":1768704916858},{"name":"Alastor","power":7906,"tacticalRank":6858,"id":1768696641001.8086,"status":"team","updatedAt":1768705750022},{"name":"Slavik","power":7465,"tacticalRank":6212,"id":1768696641001.5615,"status":"team","updatedAt":1768705575781},{"name":"sanich","power":7706,"tacticalRank":10308,"id":1768696641001.3848,"status":"team","updatedAt":1768704619246},{"id":1768704326842.6355,"name":"diavolica","power":11531,"tacticalRank":10704,"status":"team","updatedAt":1768704615249},{"name":"Mateus.castro","power":6245,"tacticalRank":6204,"id":1768696641001.7292,"status":"team","updatedAt":1768704670165},{"name":"MORBID","power":9860,"tacticalRank":7906,"id":1768696641001.1965,"status":"team","updatedAt":1768706205415},{"name":"AlexM37","power":6212,"tacticalRank":6157,"id":1768696641001.6775,"status":"team","updatedAt":1768762611987},{"name":"8up","power":10070,"tacticalRank":9220,"id":1768696641001.572,"status":"team","updatedAt":1768706187606},{"name":"SkyL","power":9422,"tacticalRank":15190,"id":1768696641001.141,"status":"team","updatedAt":1768704389587},{"name":"Golferguy667","power":16866,"tacticalRank":16866,"id":1768696641001.8315,"status":"team","updatedAt":1768704361200},{"name":"Bravos","power":17345,"tacticalRank":17345,"id":1768696641001.2954,"status":"team","updatedAt":1768704361201},{"name":"Big Fish","power":7403,"tacticalRank":7403,"id":1768696641001.574,"status":"team","updatedAt":1768704361202},{"name":"BDE","power":10308,"tacticalRank":11531,"id":1768696641001.4521,"status":"team","updatedAt":1768705719397},{"name":"Lilly","power":6204,"tacticalRank":4707,"id":1768696641001.9946,"status":"bench","updatedAt":1768762616258},{"name":"Angara","power":5225,"tacticalRank":7706,"id":1768696641001.654,"status":"team","updatedAt":1768708436149},{"name":"B71","power":7534,"tacticalRank":7534,"id":1768696641001.126,"status":"bench","updatedAt":1768704361206},{"name":"Chudson357","power":5115,"tacticalRank":5115,"id":1768696641001.699,"status":"bench","updatedAt":1768704361207},{"name":"Marco","power":8686,"tacticalRank":8686,"id":1768696641001.3723,"status":"bench","updatedAt":1768704361208},{"name":"steph43","power":15019,"tacticalRank":15019,"id":1768696641001.9343,"status":"bench","updatedAt":1768704361209},{"name":"Rhodie","power":9508,"tacticalRank":9508,"id":1768696641001.8,"status":"bench","updatedAt":1768704361210},{"name":"AVB0516!","power":4706,"tacticalRank":4706,"id":1768696641001.974,"status":"bench","updatedAt":1768704361211},{"name":"Ext4zy","power":5573,"tacticalRank":5573,"id":1768696641001.219,"status":"bench","updatedAt":1768704361212},{"name":"postie08","power":4572,"tacticalRank":4572,"id":1768696641001.0754,"status":"bench","updatedAt":1768704361213},{"name":"Patriot","power":3712,"tacticalRank":9422,"id":1768696641001.1406,"status":"team","updatedAt":1768760213952},{"name":"Danniella26","power":4707,"tacticalRank":3377,"id":1768696641001.9238,"status":"team","updatedAt":1768762616258},{"name":"Dasha","power":6858,"tacticalRank":6858,"id":1768696641001.3909,"status":"off","updatedAt":1768704326850},{"name":"diavoliva","power":11531,"tacticalRank":11531,"id":1768696641001.2268,"status":"off","updatedAt":1768704326860}]; 

        let players = []; 
        let currentPhase = 1;
        let isAdmin = false;
        let currentLang = 'en';
        let zoomLevel = 1.0;
        let panX = 0;
        let panY = 0;
        let searchQuery = "";
        let searchSelectedId = null;
        let replaceSourceId = null;
        let modalActiveView = "";
        let transformQueued = false;
        let suppressSearchInput = false;

        const i18n = {
            en: {
                "sub-header": "Tactical Deployment System", "admin-only": "(Richard Only)", "search-placeholder": "Search your name...", "phase1": "PHASE 1: START", "phase2": "PHASE 2: 10M+", "view-map": "MAP VIEW", "view-admin": "ADMIN", jokers: "Jokers (4)", "joker-desc": "if your building is secure go look for water tanks when they start spawning.", movement: "Phase Movement", "movement-desc": "Red/Green/Yellow bubbles show players moving to key buildings as soon as they are available.", "center": "Central Reservoir", "solar": "Solar Power Station", "helipad": "Abandoned Helipad", "dev": "Dev Compound", "munition": "Munition Factory", "wt": "Water Treatment Center", "wp": "Water Processing Plant", "hint-mobile": "Use two fingers to move the map", "hint-search": "Search your name for full instructions", "msg-assigned": "{name}, you are assigned to {building}.", "msg-joker": "You are one of the jokers. Make sure to check the special instructions for jokers.", "msg-captain": "Please message your team: {team_list}. Make sure they understand the instructions for your team.", "msg-move-detailed": "You will move between phases. You will start by helping in {start_building} and then move to {final_building} as soon as it is available, until the end of the raid. It doesn't matter how easy or difficult the fight in {start_building} is, move to your assigned building as soon as it is open. Make sure to check both Phase 1 and 2 to see where to go. Once you are there---", "msg-stay": "You will not move between phases. Defend your building.", "msg-reservist": "{name}, you are one of the reservists! Check back 5 minutes before the raid.", "msg-not-selected": "{name}, you weren't selected this week.", "got-it": "Got it", "take-me-there": "Take me there"
            },
            pt: {
                "sub-header": "Sistema de Implementa√ß√£o T√°tica", "admin-only": "(Apenas Richard)", "search-placeholder": "Busque seu nome...", "phase1": "FASE 1: IN√çCIO", "phase2": "FASE 2: 10M+", "view-map": "MAPA", "view-admin": "ADMIN", jokers: "Curingas (3¬∫ e 4¬∫)", "joker-desc": "se o centro estiver seguro, procure tanques de √°gua quando come√ßarem a surgir ou ofere√ßa ajuda onde for necess√°rio. se n√£o, ajude a lutar pelo centro.", movement: "Movimenta√ß√£o", "movement-desc": "Bal√µes coloridos mostram jogadores mudando para pr√©dios-chave.", "center": "Reservat√≥rio Central", "solar": "Esta√ß√£o Solar", "helipad": "Heliporto", "dev": "Composto Dev", "munition": "F√°brica de Muni√ß√£o", "wt": "Tratamento de √Ågua", "wp": "Planta de √Ågua", "hint-mobile": "Use dois dedos para mover o mapa", "hint-search": "Busque seu nome para instru√ß√µes completas", "msg-assigned": "{name}, voc√™ est√° em: {building}.", "msg-joker": "Voc√™ √© um curinga. Veja as instru√ß√µes.", "msg-move-detailed": "Voce vai se mover entre fases. Voce vai comecar ajudando em {start_building} e depois ir para {final_building} assim que estiver disponivel, ate o fim da raid. Nao importa se a luta em {start_building} esta facil ou dificil, mude para seu predio assim que abrir. Verifique as Fases 1 e 2 para saber onde ir. Quando chegar la---", "msg-stay": "Defenda seu pr√©dio.", "msg-reservist": "{name}, voc√™ √© reserva!", "msg-not-selected": "{name}, n√£o selecionado.", "got-it": "Entendi", "take-me-there": "Leve-me l√°"
            },
            es: {
                "sub-header": "Sistema de Despliegue T√°ctico", "admin-only": "(Solo Richard)", "search-placeholder": "Busca tu nombre...", "phase1": "FASE 1: INICIO", "phase2": "FASE 2: 10M+", "view-map": "MAPA", "view-admin": "ADMIN", jokers: "Comodines (3¬∫ y 4¬∫)", "joker-desc": "si el centro est√° seguro, busca tanques de agua o ayuda donde sea necesario. si no, ayuda a luchar por el centro.", movement: "Movimiento", "movement-desc": "Las burbujas muestran el movimiento a edificios clave.", "center": "Embalse Central", "solar": "Estaci√≥n Solar", "helipad": "Helipuerto", "dev": "Compuesto Dev", "munition": "F√°brica de Munici√≥n", "wt": "Tratamiento de Agua", "wp": "Planta de Agua", "hint-mobile": "Usa dos dedos para mover el mapa", "hint-search": "Busca tu nombre para instrucciones", "msg-assigned": "{name}, est√°s en: {building}.", "msg-joker": "Eres un comod√≠n.", "msg-move-detailed": "Te moveras entre fases. Comenzaras ayudando en {start_building} y luego iras a {final_building} en cuanto este disponible, hasta el final de la raid. No importa si la pelea en {start_building} es facil o dificil, ve a tu edificio asignado en cuanto se abra. Revisa las Fases 1 y 2 para saber adonde ir. Cuando llegues alli---", "msg-stay": "Defiende tu edificio.", "msg-reservist": "{name}, ¬°eres reserva!", "msg-not-selected": "{name}, no seleccionado.", "got-it": "Hecho", "take-me-there": "Ll√©vame all√≠"
            },
            fr: {
                "sub-header": "Syst√®me Tactique", "admin-only": "(Richard Uniquement)", "search-placeholder": "Cherchez votre nom...", "phase1": "PHASE 1", "phase2": "PHASE 2", "view-map": "CARTE", "view-admin": "ADMIN", jokers: "Jokers", "take-me-there": "Amenez-moi l√†", "got-it": "D'accord"
            },
            zh: {
                "sub-header": "ÊàòÊúØÈÉ®ÁΩ≤Á≥ªÁªü", "admin-only": "(‰ªÖÈôê Richard)", "search-placeholder": "ÊêúÁ¥¢‰Ω†ÁöÑÂêçÂ≠ó...", "phase1": "Á¨¨‰∏ÄÈò∂ÊÆµ", "phase2": "Á¨¨‰∫åÈò∂ÊÆµ", "view-map": "Êü•ÁúãÂú∞Âõæ", "view-admin": "ÁÆ°ÁêÜÁïåÈù¢", jokers: "Â∞è‰∏ë", "take-me-there": "Â∏¶ÊàëÂéªÈÇ£Èáå", "got-it": "Áü•ÈÅì‰∫Ü"
            },
            ru: {
                "sub-header": "–°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è", "admin-only": "(–†–∏—á–∞—Ä–¥)", "search-placeholder": "–ü–æ–∏—Å–∫ –∏–º–µ–Ω–∏...", "phase1": "–§–ê–ó–ê 1", "phase2": "–§–ê–ó–ê 2", "view-map": "–ö–ê–†–¢–ê", "view-admin": "–ê–î–ú–ò–ù", jokers: "–î–∂–æ–∫–µ—Ä—ã", "take-me-there": "–ü–µ—Ä–µ–π—Ç–∏ —Ç—É–¥–∞", "got-it": "–ü–æ–Ω—è—Ç–Ω–æ"
            }
        };

        const i18nOverrides = {
    "en": {
        "jokers": "Jokers (4)",
        "joker-desc": "if your building is secure go look for water tanks when they start spawning. its more important that you keep knocking them off the water tanks so they don't get a chance to collect it then you collect one by yourself. don't let them collect tanks.",
        "msg-captain": "You are the team captain, please message the people in your team: {team_list} to make sure they understood the instructions on what your team has to do during the event. If you don't understand the instructions, ask Richard. If you haven't heard from someone in your team at least one hour before the event, tell Richard so he can swap them for a reservist.",
        "msg-move-detailed": "You will move between phases. You will start by helping in {start_building} and then move to {final_building} as soon as it is available, until the end of the raid. It doesn't matter how easy or difficult the fight in {start_building} is, move to your assigned building as soon as it is open. Make sure to check both Phase 1 and 2 to see where to go. Once you are there---",
        "msg-stay": "Defend your building. Do not move to another building midway through! If you get teleported away, teleport back. Do not go help people asking for help in chat. Do not go after water tanks. Defend your building and attack the people around it."
    },
    "pt": {
        "jokers": "Curingas (4)",
        "joker-desc": "se seu predio estiver seguro, va procurar os tanques de agua quando comecarem a aparecer. e mais importante derrubar eles dos tanques para nao coletarem do que coletar um sozinho. nao deixe eles coletarem tanques.",
        "msg-captain": "Voce e o capitao do time. Mande mensagem para as pessoas do seu time: {team_list} para garantir que entenderam as instrucoes do que seu time precisa fazer no evento. Se nao entender as instrucoes, fale com o Richard. Se nao ouvir de alguem do seu time pelo menos uma hora antes do evento, avise o Richard para ele trocar por um reserva.",
        "msg-move-detailed": "Voce vai se mover entre fases. Voce vai comecar ajudando em {start_building} e depois ir para {final_building} assim que estiver disponivel, ate o fim da raid. Nao importa se a luta em {start_building} esta facil ou dificil, mude para seu predio assim que abrir. Verifique as Fases 1 e 2 para saber onde ir. Quando chegar la---",
        "msg-stay": "Defenda seu predio. Nao mude para outro predio no meio! Se voce for teleportado para longe, teleporte de volta. Nao va ajudar pessoas pedindo ajuda no chat. Nao va atras de tanques de agua. Defenda seu predio e ataque as pessoas ao redor."
    },
    "es": {
        "jokers": "Comodines (4)",
        "joker-desc": "si tu edificio esta seguro, ve a buscar los tanques de agua cuando empiecen a aparecer. es mas importante tumbarlos de los tanques para que no puedan recolectar que recolectar uno tu solo. no dejes que recolecten tanques.",
        "msg-captain": "Eres el capitan del equipo. Escribe a las personas de tu equipo: {team_list} para asegurarte de que entendieron las instrucciones de lo que su equipo debe hacer en el evento. Si no entiendes las instrucciones, habla con Richard. Si no has sabido de alguien de tu equipo al menos una hora antes del evento, avisa a Richard para cambiarlo por un reserva.",
        "msg-move-detailed": "Te moveras entre fases. Comenzaras ayudando en {start_building} y luego iras a {final_building} en cuanto este disponible, hasta el final de la raid. No importa si la pelea en {start_building} es facil o dificil, ve a tu edificio asignado en cuanto se abra. Revisa las Fases 1 y 2 para saber adonde ir. Cuando llegues alli---",
        "msg-stay": "Defiende tu edificio. No te muevas a otro edificio a mitad de camino. Si te teletransportan lejos, vuelve a teletransportarte. No vayas a ayudar a la gente que pide ayuda en el chat. No vayas por los tanques de agua. Defiende tu edificio y ataca a la gente alrededor."
    },
    "fr": {
        "sub-header": "Systeme de deploiement tactique",
        "search-placeholder": "Cherchez votre nom...",
        "phase1": "PHASE 1 : DEBUT",
        "phase2": "PHASE 2 : 10M+",
        "view-map": "CARTE",
        "view-admin": "ADMIN",
        "jokers": "Jokers (4)",
        "joker-desc": "si votre batiment est securise, allez voir les stations d'eau quand elles apparaissent. il est plus important de les repousser des stations pour qu'ils ne puissent pas collecter que de collecter vous-meme. ne les laissez pas collecter.",
        "movement": "Mouvement",
        "movement-desc": "Les bulles indiquent les joueurs qui se deplacent vers les batiments cles.",
        "center": "Reservoir central",
        "solar": "Station solaire",
        "helipad": "Heliport abandonne",
        "dev": "Complexe Dev",
        "munition": "Usine de munitions",
        "wt": "Centre de traitement de l'eau",
        "wp": "Usine de traitement de l'eau",
        "hint-mobile": "Utilisez un doigt pour deplacer la carte",
        "hint-search": "Cherchez votre nom pour les instructions completes",
        "msg-assigned": "{name}, vous etes assigne a {building}.",
        "msg-joker": "Vous etes l'un des jokers.",
        "msg-captain": "Vous etes le capitaine d'equipe. Envoyez un message aux personnes de votre equipe : {team_list} pour verifier qu'elles ont compris les instructions de votre equipe. Si vous ne comprenez pas les instructions, demandez a Richard. Si vous n'avez pas de nouvelles d'une personne au moins une heure avant l'evenement, prevenez Richard pour la remplacer par un reserviste.",
        "msg-move-detailed": "Vous bougerez entre les phases. Vous commencerez a {start_building} puis irez a {final_building} des qu'il sera disponible, jusqu'a la fin du raid. Peu importe si le combat a {start_building} est facile ou difficile, allez a votre batiment des qu'il ouvre. Verifiez les phases 1 et 2 pour savoir ou aller. Une fois sur place---",
        "msg-stay": "Vous ne bougerez pas entre les phases. Defendez votre batiment. Ne changez pas de batiment en cours de route. Si vous etes teleporte ailleurs, revenez. N'allez pas aider les personnes qui demandent de l'aide dans le chat. N'allez pas aux stations d'eau. Defendez votre batiment et attaquez les ennemis autour.",
        "msg-reservist": "{name}, vous etes reserviste ! Revenez 5 minutes avant le raid.",
        "msg-not-selected": "{name}, vous n'avez pas ete selectionne cette semaine.",
        "got-it": "Compris",
        "take-me-there": "Emmenez-moi"
    },
    "zh": {
        "sub-header": "\u6218\u672f\u90e8\u7f72\u7cfb\u7edf",
        "admin-only": "(\u4ec5\u9650 Richard)",
        "search-placeholder": "\u641c\u7d22\u4f60\u7684\u540d\u5b57...",
        "phase1": "\u7b2c\u4e00\u9636\u6bb5\uff1a\u5f00\u59cb",
        "phase2": "\u7b2c\u4e8c\u9636\u6bb5\uff1a10M+",
        "view-map": "\u5730\u56fe",
        "view-admin": "\u7ba1\u7406",
        "jokers": "\u5c0f\u4e11\uff084\uff09",
        "joker-desc": "\u5982\u679c\u4f60\u7684\u5efa\u7b51\u5b89\u5168\uff0c\u8bf7\u5728\u6c34\u5904\u7406\u5382\u5f00\u59cb\u5237\u65b0\u65f6\u8fc7\u53bb\u67e5\u770b\u3002\u66f4\u91cd\u8981\u7684\u662f\u628a\u4ed6\u4eec\u4ece\u6c34\u7bb1\u4e0a\u6253\u4e0b\u53bb\uff0c\u8ba9\u4ed6\u4eec\u65e0\u6cd5\u6536\u96c6\uff0c\u800c\u4e0d\u662f\u81ea\u5df1\u6536\u96c6\u3002\u4e0d\u8981\u8ba9\u4ed6\u4eec\u62ff\u5230\u6c34\u7bb1\u3002",
        "movement": "\u9636\u6bb5\u79fb\u52a8",
        "movement-desc": "\u7ea2/\u7eff/\u9ec4\u6c14\u6ce1\u8868\u793a\u73a9\u5bb6\u79fb\u52a8\u5230\u5173\u952e\u5efa\u7b51\u3002",
        "center": "\u4e2d\u592e\u6c34\u5e93",
        "solar": "\u592a\u9633\u80fd\u7535\u7ad9",
        "helipad": "\u5e9f\u5f03\u505c\u673a\u576a",
        "dev": "\u5f00\u53d1\u533a",
        "munition": "\u5f39\u836f\u5de5\u5382",
        "wt": "\u6c34\u5904\u7406\u4e2d\u5fc3",
        "wp": "\u6c34\u5904\u7406\u5382",
        "hint-mobile": "\u7528\u4e00\u6839\u624b\u6307\u79fb\u52a8\u5730\u56fe",
        "hint-search": "\u641c\u7d22\u4f60\u7684\u540d\u5b57\u67e5\u770b\u5b8c\u6574\u6307\u4ee4",
        "msg-assigned": "{name}\uff0c\u4f60\u88ab\u5206\u914d\u5230{building}\u3002",
        "msg-joker": "\u4f60\u662f\u5c0f\u4e11\u4e4b\u4e00\u3002",
        "msg-captain": "\u4f60\u662f\u961f\u957f\uff0c\u8bf7\u8054\u7cfb\u4f60\u961f\u4f0d\u4e2d\u7684\u4eba\uff1a{team_list}\uff0c\u786e\u4fdd\u4ed6\u4eec\u7406\u89e3\u4f60\u4eec\u961f\u4f0d\u5728\u6d3b\u52a8\u4e2d\u7684\u4efb\u52a1\u3002\u5982\u679c\u4f60\u4e0d\u660e\u767d\u6307\u4ee4\uff0c\u8bf7\u95ee Richard\u3002\u5982\u679c\u5728\u6d3b\u52a8\u524d\u81f3\u5c11\u4e00\u5c0f\u65f6\u4ecd\u672a\u6536\u5230\u961f\u5458\u56de\u5e94\uff0c\u8bf7\u544a\u8bc9 Richard \u4ee5\u4fbf\u66f4\u6362\u66ff\u8865\u3002",
        "msg-move-detailed": "\u4f60\u4f1a\u5728\u9636\u6bb5\u4e4b\u95f4\u79fb\u52a8\u3002\u5148\u5230{start_building}\u5e2e\u5fd9\uff0c\u7136\u540e\u5728{final_building}\u4e00\u5f00\u653e\u5c31\u79fb\u52a8\u8fc7\u53bb\uff0c\u76f4\u5230\u6d3b\u52a8\u7ed3\u675f\u3002\u65e0\u8bba{start_building}\u7684\u6218\u6597\u6709\u591a\u5bb9\u6613\u6216\u56f0\u96be\uff0c\u90fd\u8981\u5728\u5f00\u653e\u540e\u7acb\u523b\u53bb\u4f60\u5206\u914d\u7684\u5efa\u7b51\u3002\u8bf7\u67e5\u770b\u7b2c1\u548c\u7b2c2\u9636\u6bb5\uff0c\u786e\u8ba4\u53bb\u54ea\u91cc\u3002\u5230\u8fbe\u540e---",
        "msg-stay": "\u4f60\u4e0d\u4f1a\u6362\u4f4d\u3002\u9632\u5b88\u4f60\u7684\u5efa\u7b51\u3002\u4e0d\u8981\u4e2d\u9014\u6362\u5230\u522b\u7684\u5efa\u7b51\uff01\u5982\u679c\u88ab\u4f20\u9001\u8d70\uff0c\u9a6c\u4e0a\u4f20\u9001\u56de\u6765\u3002\u4e0d\u8981\u53bb\u5e2e\u804a\u5929\u91cc\u6c42\u52a9\u7684\u4eba\u3002\u4e0d\u8981\u53bb\u62a2\u6c34\u7bb1\u3002\u9632\u5b88\u4f60\u7684\u5efa\u7b51\u5e76\u653b\u51fb\u5468\u56f4\u7684\u4eba\u3002",
        "msg-reservist": "{name}\uff0c\u4f60\u662f\u66ff\u8865\uff01\u8bf7\u5728\u6d3b\u52a8\u524d5\u5206\u949f\u518d\u67e5\u770b\u3002",
        "msg-not-selected": "{name}\uff0c\u4f60\u672c\u5468\u672a\u88ab\u9009\u4e2d\u3002",
        "got-it": "\u77e5\u9053\u4e86",
        "take-me-there": "\u5e26\u6211\u8fc7\u53bb"
    },
    "ru": {
        "sub-header": "\u0421\u0438\u0441\u0442\u0435\u043c\u0430 \u0442\u0430\u043a\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u0440\u0430\u0437\u0432\u0435\u0440\u0442\u044b\u0432\u0430\u043d\u0438\u044f",
        "admin-only": "(\u0422\u043e\u043b\u044c\u043a\u043e \u0420\u0438\u0447\u0430\u0440\u0434)",
        "search-placeholder": "\u041f\u043e\u0438\u0441\u043a \u0438\u043c\u0435\u043d\u0438...",
        "phase1": "\u0424\u0410\u0417\u0410 1: \u0421\u0422\u0410\u0420\u0422",
        "phase2": "\u0424\u0410\u0417\u0410 2: 10M+",
        "view-map": "\u041a\u0410\u0420\u0422\u0410",
        "view-admin": "\u0410\u0414\u041c\u0418\u041d",
        "jokers": "\u0414\u0436\u043e\u043a\u0435\u0440\u044b (4)",
        "joker-desc": "\u0415\u0441\u043b\u0438 \u0432\u0430\u0448\u0435 \u0437\u0434\u0430\u043d\u0438\u0435 \u0432 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438, \u043f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 \u0432\u043e\u0434\u043e\u043e\u0447\u0438\u0441\u0442\u043d\u044b\u0435 \u0441\u0442\u0430\u043d\u0446\u0438\u0438, \u043a\u043e\u0433\u0434\u0430 \u043e\u043d\u0438 \u043d\u0430\u0447\u043d\u0443\u0442 \u043f\u043e\u044f\u0432\u043b\u044f\u0442\u044c\u0441\u044f. \u0412\u0430\u0436\u043d\u043e \u0441\u0431\u0438\u0432\u0430\u0442\u044c \u0438\u0445 \u0441 \u0440\u0435\u0437\u0435\u0440\u0432\u0443\u0430\u0440\u043e\u0432, \u0447\u0442\u043e\u0431\u044b \u043e\u043d\u0438 \u043d\u0435 \u043c\u043e\u0433\u043b\u0438 \u0441\u043e\u0431\u0438\u0440\u0430\u0442\u044c, \u0430 \u043d\u0435 \u0441\u043e\u0431\u0438\u0440\u0430\u0442\u044c \u0441\u0430\u043c\u043e\u043c\u0443. \u041d\u0435 \u0434\u0430\u0439\u0442\u0435 \u0438\u043c \u0441\u043e\u0431\u0440\u0430\u0442\u044c \u0440\u0435\u0437\u0435\u0440\u0432\u0443\u0430\u0440\u044b.",
        "movement": "\u041f\u0435\u0440\u0435\u043c\u0435\u0449\u0435\u043d\u0438\u0435",
        "movement-desc": "\u041a\u0440\u0430\u0441\u043d\u044b\u0435/\u0437\u0435\u043b\u0435\u043d\u044b\u0435/\u0436\u0435\u043b\u0442\u044b\u0435 \u043f\u0443\u0437\u044b\u0440\u044c\u043a\u0438 \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u044e\u0442 \u0434\u0432\u0438\u0436\u0435\u043d\u0438\u0435 \u043a \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u043c \u0437\u0434\u0430\u043d\u0438\u044f\u043c.",
        "center": "\u0426\u0435\u043d\u0442\u0440\u0430\u043b\u044c\u043d\u044b\u0439 \u0440\u0435\u0437\u0435\u0440\u0432\u0443\u0430\u0440",
        "solar": "\u0421\u043e\u043b\u043d\u0435\u0447\u043d\u0430\u044f \u044d\u043b\u0435\u043a\u0442\u0440\u043e\u0441\u0442\u0430\u043d\u0446\u0438\u044f",
        "helipad": "\u0417\u0430\u0431\u0440\u043e\u0448\u0435\u043d\u043d\u0430\u044f \u0432\u0435\u0440\u0442\u043e\u043b\u0435\u0442\u043d\u0430\u044f \u043f\u043b\u043e\u0449\u0430\u0434\u043a\u0430",
        "dev": "\u041a\u043e\u043c\u043f\u043b\u0435\u043a\u0441 Dev",
        "munition": "\u0417\u0430\u0432\u043e\u0434 \u0431\u043e\u0435\u043f\u0440\u0438\u043f\u0430\u0441\u043e\u0432",
        "wt": "\u0412\u043e\u0434\u043e\u043e\u0447\u0438\u0441\u0442\u043d\u044b\u0439 \u0446\u0435\u043d\u0442\u0440",
        "wp": "\u0412\u043e\u0434\u043e\u043e\u0447\u0438\u0441\u0442\u043d\u0430\u044f \u0441\u0442\u0430\u043d\u0446\u0438\u044f",
        "hint-mobile": "\u041f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0439\u0442\u0435 \u043a\u0430\u0440\u0442\u0443 \u043e\u0434\u043d\u0438\u043c \u043f\u0430\u043b\u044c\u0446\u0435\u043c",
        "hint-search": "\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0438\u043c\u044f \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0439",
        "msg-assigned": "{name}, \u0432\u044b \u043d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u044b \u0432 {building}.",
        "msg-joker": "\u0412\u044b \u043e\u0434\u0438\u043d \u0438\u0437 \u0434\u0436\u043e\u043a\u0435\u0440\u043e\u0432.",
        "msg-captain": "\u0412\u044b \u043a\u0430\u043f\u0438\u0442\u0430\u043d \u043a\u043e\u043c\u0430\u043d\u0434\u044b. \u041d\u0430\u043f\u0438\u0448\u0438\u0442\u0435 \u043b\u044e\u0434\u044f\u043c \u0438\u0437 \u0432\u0430\u0448\u0435\u0439 \u043a\u043e\u043c\u0430\u043d\u0434\u044b: {team_list}, \u0447\u0442\u043e\u0431\u044b \u0443\u0431\u0435\u0434\u0438\u0442\u044c\u0441\u044f, \u0447\u0442\u043e \u043e\u043d\u0438 \u043f\u043e\u043d\u044f\u043b\u0438 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438 \u043e \u0442\u043e\u043c, \u0447\u0442\u043e \u0434\u043e\u043b\u0436\u043d\u0430 \u0434\u0435\u043b\u0430\u0442\u044c \u0432\u0430\u0448\u0430 \u043a\u043e\u043c\u0430\u043d\u0434\u0430 \u043d\u0430 \u0441\u043e\u0431\u044b\u0442\u0438\u0438. \u0415\u0441\u043b\u0438 \u0432\u044b \u043d\u0435 \u043f\u043e\u043d\u0438\u043c\u0430\u0435\u0442\u0435 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438, \u0441\u043f\u0440\u043e\u0441\u0438\u0442\u0435 \u0420\u0438\u0447\u0430\u0440\u0434\u0430. \u0415\u0441\u043b\u0438 \u0437\u0430 \u0447\u0430\u0441 \u0434\u043e \u0441\u043e\u0431\u044b\u0442\u0438\u044f \u0432\u044b \u043d\u0435 \u043f\u043e\u043b\u0443\u0447\u0438\u043b\u0438 \u043e\u0442\u0432\u0435\u0442 \u043e\u0442 \u0443\u0447\u0430\u0441\u0442\u043d\u0438\u043a\u0430 \u043a\u043e\u043c\u0430\u043d\u0434\u044b, \u0441\u043e\u043e\u0431\u0449\u0438\u0442\u0435 \u0420\u0438\u0447\u0430\u0440\u0434\u0443, \u0447\u0442\u043e\u0431\u044b \u0437\u0430\u043c\u0435\u043d\u0438\u0442\u044c \u0435\u0433\u043e \u0440\u0435\u0437\u0435\u0440\u0432\u0438\u0441\u0442\u043e\u043c.",
        "msg-move-detailed": "\u0412\u044b \u0431\u0443\u0434\u0435\u0442\u0435 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0442\u044c\u0441\u044f \u043c\u0435\u0436\u0434\u0443 \u0444\u0430\u0437\u0430\u043c\u0438. \u0421\u043d\u0430\u0447\u0430\u043b\u0430 \u043f\u043e\u043c\u043e\u0433\u0430\u0439\u0442\u0435 \u0432 {start_building}, \u0437\u0430\u0442\u0435\u043c \u043f\u0435\u0440\u0435\u0445\u043e\u0434\u0438\u0442\u0435 \u0432 {final_building}, \u043a\u0430\u043a \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u043d \u0441\u0442\u0430\u043d\u0435\u0442 \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d, \u0434\u043e \u043a\u043e\u043d\u0446\u0430 \u0440\u0435\u0439\u0434\u0430. \u041d\u0435\u0432\u0430\u0436\u043d\u043e, \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043b\u0435\u0433\u043a\u0438\u0439 \u0438\u043b\u0438 \u0441\u043b\u043e\u0436\u043d\u044b\u0439 \u0431\u043e\u0439 \u0432 {start_building}, \u043f\u0435\u0440\u0435\u0445\u043e\u0434\u0438\u0442\u0435 \u0432 \u043d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u043d\u043e\u0435 \u0437\u0434\u0430\u043d\u0438\u0435 \u0441\u0440\u0430\u0437\u0443 \u043f\u043e\u0441\u043b\u0435 \u043e\u0442\u043a\u0440\u044b\u0442\u0438\u044f. \u041f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 \u0444\u0430\u0437\u044b 1 \u0438 2, \u0447\u0442\u043e\u0431\u044b \u0437\u043d\u0430\u0442\u044c, \u043a\u0443\u0434\u0430 \u0438\u0434\u0442\u0438. \u041a\u043e\u0433\u0434\u0430 \u0432\u044b \u043e\u043a\u0430\u0436\u0435\u0442\u0435\u0441\u044c \u0442\u0430\u043c---",
        "msg-stay": "\u0412\u044b \u043d\u0435 \u0431\u0443\u0434\u0435\u0442\u0435 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0442\u044c\u0441\u044f. \u0417\u0430\u0449\u0438\u0449\u0430\u0439\u0442\u0435 \u0437\u0434\u0430\u043d\u0438\u0435. \u041d\u0435 \u043f\u0435\u0440\u0435\u0445\u043e\u0434\u0438\u0442\u0435 \u0432 \u0434\u0440\u0443\u0433\u043e\u0435 \u0437\u0434\u0430\u043d\u0438\u0435 \u043f\u043e\u0441\u0440\u0435\u0434\u0438 \u0431\u043e\u044f. \u0415\u0441\u043b\u0438 \u0432\u0430\u0441 \u0442\u0435\u043b\u0435\u043f\u043e\u0440\u0442\u0438\u0440\u043e\u0432\u0430\u043b\u0438, \u0432\u0435\u0440\u043d\u0438\u0442\u0435\u0441\u044c \u043e\u0431\u0440\u0430\u0442\u043d\u043e. \u041d\u0435 \u043f\u043e\u043c\u043e\u0433\u0430\u0439\u0442\u0435 \u0442\u0435\u043c, \u043a\u0442\u043e \u043f\u0440\u043e\u0441\u0438\u0442 \u043f\u043e\u043c\u043e\u0449\u0438 \u0432 \u0447\u0430\u0442\u0435. \u041d\u0435 \u0438\u0434\u0438\u0442\u0435 \u0437\u0430 \u0432\u043e\u0434\u044f\u043d\u044b\u043c\u0438 \u0431\u0430\u043a\u0430\u043c\u0438. \u0417\u0430\u0449\u0438\u0449\u0430\u0439\u0442\u0435 \u0437\u0434\u0430\u043d\u0438\u0435 \u0438 \u0430\u0442\u0430\u043a\u0443\u0439\u0442\u0435 \u0432\u0440\u0430\u0433\u043e\u0432 \u0432\u043e\u043a\u0440\u0443\u0433.",
        "msg-reservist": "{name}, \u0432\u044b \u0440\u0435\u0437\u0435\u0440\u0432\u0438\u0441\u0442! \u041f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 \u0437\u0430 5 \u043c\u0438\u043d\u0443\u0442 \u0434\u043e \u0440\u0435\u0439\u0434\u0430.",
        "msg-not-selected": "{name}, \u0432\u044b \u043d\u0435 \u0432\u044b\u0431\u0440\u0430\u043d\u044b \u043d\u0430 \u044d\u0442\u043e\u0439 \u043d\u0435\u0434\u0435\u043b\u0435.",
        "got-it": "\u041f\u043e\u043d\u044f\u0442\u043d\u043e",
        "take-me-there": "\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c"
    }
};

        const t = (key) => {
            const override = i18nOverrides[currentLang] && i18nOverrides[currentLang][key];
            if (override) return override;
            if (i18n[currentLang] && i18n[currentLang][key]) return i18n[currentLang][key];
            if (i18n.en && i18n.en[key]) return i18n.en[key];
            return key;
        };

        const BUILDING_CONFIG = [
            { id: 'center', nameKey: 'center', x: 50, y: 50, capacity: 4, icon: 'center.png', imgSize: 200, labelScale: 1.1 },
            { id: 'dev', nameKey: 'dev', x: 34, y: 38, capacity: 3, icon: 'dev.png', imgSize: 110 },
            { id: 'wt1', nameKey: 'wt', nameSuffix: ' #1', x: 68, y: 38, capacity: 2, icon: 'wc1.png', imgSize: 120 },
            { id: 'wt2', nameKey: 'wt', nameSuffix: ' #2', x: 35, y: 73, capacity: 2, icon: 'wc2.png', imgSize: 120 },
            { id: 'munition', nameKey: 'munition', x: 69, y: 65, capacity: 3, icon: 'munition.png', imgSize: 110 },
            { id: 'solar', nameKey: 'solar', x: 12, y: 38, capacity: 4, icon: 'solar.png', imgSize: 100 },
            { id: 'wp1', nameKey: 'wp', nameSuffix: ' #1', x: 25, y: 18, capacity: 2, icon: 'wp.png', imgSize: 70 },
            { id: 'wp2', nameKey: 'wp', nameSuffix: ' #2', x: 82, y: 18, capacity: 2, icon: 'wp.png', imgSize: 70 },
            { id: 'helipad', nameKey: 'helipad', x: 86, y: 80, capacity: 4, icon: 'helipad.png', imgSize: 100 },
            { id: 'wp4', nameKey: 'wp', nameSuffix: ' #4', x: 69, y: 86, capacity: 2, icon: 'wp.png', imgSize: 70 },
            { id: 'wp3', nameKey: 'wp', nameSuffix: ' #3', x: 18, y: 82, capacity: 2, icon: 'wp.png', imgSize: 70 },
        ];

        // --- LOGIC ---

        window.onload = () => {
            const saved = localStorage.getItem('res_raid_static_data_v1');
            players = (saved ? JSON.parse(saved) : INITIAL_DATA).map(p => ({...p, updatedAt: p.updatedAt || 0}));
            renderMap();
            applyI18n();
            setupInteractions();

            setTimeout(() => {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    document.getElementById('lang-modal').classList.remove('hidden');
                    document.getElementById('lang-modal').classList.add('flex');
                }, 800);
            }, 1800);
        };

        function setupInteractions() {
            const vp = document.getElementById('viewport');
            const root = document.getElementById('map-root');
            let isDragging = false;
            let startX, startY;
            let isPinching = false;
            let pinchStartDistance = 0;
            let pinchStartZoom = 1;
            let pinchMapX = 0;
            let pinchMapY = 0;
            let touchMode = '';
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartPanX = 0;
            let touchStartPanY = 0;
            const setPanning = (active) => {
                if (!root) return;
                root.classList.toggle('is-panning', active);
            };

            vp.addEventListener('mousedown', (e) => {
                if (e.target.closest('.player-bubble') || e.target.closest('.ctrl-btn')) return;
                isDragging = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                setPanning(true);
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                applyTransform();
            });

            window.addEventListener('mouseup', () => {
                if (!isDragging) return;
                isDragging = false;
                setPanning(false);
            });

            vp.addEventListener('touchstart', (e) => {
                if (e.target.closest('.player-bubble')) return;
                if (e.touches.length === 2) {
                    isDragging = true;
                    isPinching = true;
                    touchMode = '';
                    pinchStartDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    pinchStartZoom = zoomLevel;
                    const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                    pinchMapX = (centerX - panX) / zoomLevel;
                    pinchMapY = (centerY - panY) / zoomLevel;
                    startX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - panX;
                    startY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - panY;
                    e.preventDefault(); 
                    setPanning(true);
                } else if (e.touches.length === 1) {
                    isDragging = false;
                    isPinching = false;
                    touchMode = '';
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    touchStartPanX = panX;
                    touchStartPanY = panY;
                    setPanning(false);
                }
            }, {passive: false});

            vp.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                if (isPinching && e.touches.length === 2) {
                    const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const nextZoom = Math.max(0.4, Math.min(3.0, pinchStartZoom * (dist / pinchStartDistance)));
                    zoomLevel = nextZoom;
                    panX = centerX - (pinchMapX * zoomLevel);
                    panY = centerY - (pinchMapY * zoomLevel);
                    const root = document.getElementById('map-root');
                    if (zoomLevel < 1.3) root.classList.add('low-zoom');
                    else root.classList.remove('low-zoom');
                    applyTransform();
                    e.preventDefault();
                    return;
                }
                if (e.touches.length !== 1) return;
            }, {passive: false});
            vp.addEventListener('touchmove', (e) => {
                if (isPinching || e.touches.length !== 1) return;
                const dx = e.touches[0].clientX - touchStartX;
                const dy = e.touches[0].clientY - touchStartY;
                if (!touchMode) {
                    if (Math.hypot(dx, dy) < 6) return;
                    if (zoomLevel > 1.05) touchMode = 'pan';
                    else touchMode = Math.abs(dx) >= Math.abs(dy) ? 'pan' : 'scroll';
                    if (touchMode === 'pan') {
                        isDragging = true;
                        setPanning(true);
                    }
                }
                if (touchMode !== 'pan') return;
                panX = touchStartPanX + dx;
                panY = touchStartPanY + dy;
                applyTransform();
                e.preventDefault();
            }, {passive: false});

            const stopTouch = () => {
                isDragging = false;
                isPinching = false;
                touchMode = '';
                setPanning(false);
            };
            vp.addEventListener('touchend', stopTouch);
            vp.addEventListener('touchcancel', stopTouch);
        }

        function applyTransform() {
            if (transformQueued) return;
            transformQueued = true;
            requestAnimationFrame(() => {
                transformQueued = false;
                const root = document.getElementById('map-root');
                if (!root) return;
                root.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
            });
        }

        function normalizeName(value) {
            return (value || '').toLowerCase().trim();
        }

        function fillTemplate(template, values) {
            let result = template || '';
            Object.keys(values || {}).forEach((key) => {
                const token = `{${key}}`;
                result = result.split(token).join(values[key]);
            });
            return result;
        }

        function getSortMode() {
            const select = document.getElementById('admin-sort');
            return select ? select.value : 'power';
        }

        function sortPlayers(list, mode) {
            const items = [...list];
            const sortMode = mode || 'power';
            if (sortMode === 'alpha') {
                return items.sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
            }
            if (sortMode === 'updated') {
                return items.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0) || (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
            }
            return items.sort((a, b) => (b.power || 0) - (a.power || 0) || (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
        }

        function refreshModalList() {
            if (modalActiveView === 'swap') showSwapList();
            if (modalActiveView === 'bench') showReplaceWithBench();
        }

        function setModalSortVisible(visible) {
            const row = document.getElementById('modal-sort-row');
            if (!row) return;
            row.classList.toggle('hidden', !visible);
            row.classList.toggle('flex', visible);
        }

        window.setSortMode = (mode) => {
            const value = mode || 'power';
            const adminSelect = document.getElementById('admin-sort');
            if (adminSelect && adminSelect.value !== value) adminSelect.value = value;
            const modalSelect = document.getElementById('modal-sort');
            if (modalSelect && modalSelect.value !== value) modalSelect.value = value;
            renderAdmin();
            refreshModalList();
        };

        function hideSearchDropdown() {
            const dropdown = document.getElementById('search-dropdown');
            if (!dropdown) return;
            dropdown.innerHTML = '';
            dropdown.classList.add('hidden');
        }

        function handleSearchInput() {
            if (suppressSearchInput) return;
            const input = document.getElementById('player-search');
            const query = normalizeName(input.value);
            const banner = document.getElementById('search-banner');
            if (!query) {
                searchQuery = "";
                searchSelectedId = null;
                banner.classList.add('hidden');
                hideSearchDropdown();
                renderMap();
                return;
            }
            searchQuery = "";
            searchSelectedId = null;
            banner.classList.add('hidden');

            const matches = players.filter(p => {
                const name = normalizeName(p.name);
                return query.length === 1 ? name.startsWith(query) : name.includes(query);
            }).sort((a, b) => normalizeName(a.name).localeCompare(normalizeName(b.name)));

            const dropdown = document.getElementById('search-dropdown');
            if (!dropdown) return;
            dropdown.innerHTML = '';
            matches.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'search-item';
                btn.type = 'button';
                btn.innerText = p.name;
                btn.onclick = () => selectSearchName(p.name);
                dropdown.appendChild(btn);
            });
            dropdown.classList.toggle('hidden', matches.length === 0);
        }

        function selectSearchName(name) {
            const input = document.getElementById('player-search');
            const match = players.find(p => normalizeName(p.name) === normalizeName(name));
            if (!match) return;
            suppressSearchInput = true;
            input.value = match.name;
            suppressSearchInput = false;
            searchQuery = normalizeName(match.name);
            searchSelectedId = match.id;
            hideSearchDropdown();
            handleSearchSelection();
        }

        function handleSearchSelection() {
            const banner = document.getElementById('search-banner');
            banner.classList.add('hidden');

            if (!searchQuery) {
                renderMap();
                return;
            }

            const distributed = calculateDistribution();
            const roles = computeTeamRoles(distributed);
            const mapMatch = distributed.find(p => p.target !== 'bench' && normalizeName(p.name) === searchQuery);
            
            if (mapMatch) {
                const p = mapMatch;
                const bConfig = BUILDING_CONFIG.find(bc => bc.id === p.target);
                const bName = t(bConfig.nameKey) + (bConfig.nameSuffix || '');
                
                const isJoker = roles.jokers.has(String(p.id));
                const isCaptain = roles.captains.has(String(p.id));
                const isMover = ['center', 'dev', 'munition'].includes(p.target);
                
                let targetBuildingForZoom = bConfig;
                if (currentPhase === 1 && isMover) {
                    let startKey = '';
                    if (p.target === 'center') {
                        const ct = distributed.filter(x => x.target === 'center');
                        const cIdx = ct.findIndex(x => x.id === p.id);
                        startKey = (cIdx === 0 || cIdx === 2) ? 'solar' : 'helipad';
                    } else if (p.target === 'dev') startKey = 'wt1';
                    else if (p.target === 'munition') startKey = 'wt2';
                    targetBuildingForZoom = BUILDING_CONFIG.find(bc => bc.id === startKey);
                }
                centerMapOnBuilding(targetBuildingForZoom);

                let msg = fillTemplate(t('msg-assigned'), { name: p.name, building: bName });
                
                if (isMover) {
                    let startKey = '';
                    if (p.target === 'center') {
                        const ct = distributed.filter(x => x.target === 'center');
                        const cIdx = ct.findIndex(x => x.id === p.id);
                        startKey = (cIdx === 0 || cIdx === 2) ? 'solar' : 'helipad';
                    } else if (p.target === 'dev') startKey = 'wt1';
                    else if (p.target === 'munition') startKey = 'wt2';
                    const sbConfig = BUILDING_CONFIG.find(bc => bc.id === startKey);
                    const sbName = t(sbConfig.nameKey) + (sbConfig.nameSuffix || '');
                    msg += " " + fillTemplate(t('msg-move-detailed'), { start_building: sbName, final_building: bName });
                    msg += " " + t('msg-stay');
                } else {
                    msg += " " + t('msg-stay');
                }

                let useHtml = false;
                if (isCaptain) {
                    const teamList = (roles.teamMembers[p.target] || []).join(', ');
                    msg += "<br><br>" + fillTemplate(t('msg-captain'), { team_list: teamList || '-' });
                    useHtml = true;
                }

                if (isJoker) {
                    msg += " " + t('msg-joker');
                    banner.innerHTML = `<div>${msg}</div><button onclick="scrollToJokers()" class="mt-4 bg-white text-indigo-600 px-6 py-2 rounded-xl text-xs font-black uppercase shadow-lg active:scale-95 transition-all">${t('take-me-there')}</button>`;
                } else if (useHtml) {
                    banner.innerHTML = msg;
                } else {
                    banner.innerText = msg;
                }
                banner.classList.remove('hidden');
            } else {
                const dbMatch = players.find(p => normalizeName(p.name) === searchQuery);
                if (dbMatch) {
                    if (dbMatch.status === 'bench') banner.innerText = fillTemplate(t('msg-reservist'), { name: dbMatch.name });
                    else banner.innerText = fillTemplate(t('msg-not-selected'), { name: dbMatch.name });
                    banner.classList.remove('hidden');
                }
            }
            renderMap();
        }

        window.adjustZoom = (delta) => {
            zoomLevel = Math.max(0.4, Math.min(3.0, zoomLevel + delta));
            const root = document.getElementById('map-root');
            if (zoomLevel < 1.3) root.classList.add('low-zoom');
            else root.classList.remove('low-zoom');
            applyTransform();
        };

        window.dismissHint = () => {
            const m = document.getElementById('mobile-hint');
            const p = document.getElementById('pc-hint');
            m.classList.add('hidden'); m.classList.remove('flex');
            p.classList.add('hidden'); p.classList.remove('flex', 'md:flex');
        };

        function applyI18n() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = t(key);
                if (value) el.innerText = value;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const value = t(key);
                if (value) el.placeholder = value;
            });
        }

        window.setLangAndClose = (l) => {
            currentLang = l;
            applyI18n();
            renderMap();
            document.getElementById('lang-modal').classList.add('hidden');
            document.getElementById('lang-modal').classList.remove('flex');

            const search = document.getElementById('player-search');
            const tip = document.getElementById('search-tip');
            search.classList.add('search-pulse');
            tip.classList.remove('hidden');

            setTimeout(() => {
                search.classList.remove('search-pulse');
                tip.classList.add('hidden');
            }, 7000);

            if (window.innerWidth < 768) {
                document.getElementById('mobile-hint').classList.add('hidden');
                document.getElementById('mobile-hint').classList.remove('flex');
            } else {
                document.getElementById('pc-hint').classList.remove('hidden');
                document.getElementById('pc-hint').classList.add('flex');
            }
        };

        window.setLang = (l) => {
            currentLang = l;
            applyI18n();
            renderMap();
            if (searchQuery) handleSearchSelection();
        };

        document.addEventListener('click', (e) => {
            const container = document.getElementById('search-container');
            if (!container || container.contains(e.target)) return;
            hideSearchDropdown();
        });

        window.setPhase = (p) => {
            currentPhase = p;
            document.getElementById('phase2-dot').classList.toggle('hidden', p===2);
            document.getElementById('btn-phase1').className = p === 1 ? 'px-6 py-2 rounded-xl text-xs font-black transition-all btn-active' : 'px-6 py-2 rounded-xl text-xs font-black transition-all btn-inactive';
            document.getElementById('btn-phase2').className = p === 2 ? 'px-6 py-2 rounded-xl text-xs font-black transition-all btn-active' : 'px-6 py-2 rounded-xl text-xs font-black transition-all btn-inactive';
            renderMap();
            if (searchQuery) handleSearchSelection();
        };

        function centerMapOnBuilding(config) {
            const vp = document.getElementById('viewport');
            const targetX = (config.x / 100) * 1000;
            const targetY = (config.y / 100) * 800;
            zoomLevel = 1.6; 
            panX = (vp.offsetWidth / 2) - (targetX * zoomLevel);
            panY = (vp.offsetHeight / 2) - (targetY * zoomLevel);
            applyTransform();
        }

        window.scrollToJokers = () => {
            document.getElementById('joker-section').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('joker-section').classList.add('ring-4', 'ring-amber-400', 'ring-offset-2');
            setTimeout(() => document.getElementById('joker-section').classList.remove('ring-4', 'ring-amber-400', 'ring-offset-2'), 3000);
        };

        function calculateDistribution() {
            const active = players.filter(p => p.status === 'team').sort((a,b) => b.tacticalRank - a.tacticalRank);
            const roster = active.map(p => ({...p}));
            const center = roster.splice(0, 4); center.forEach(p => p.target = 'center');
            const outerHigh = roster.splice(0, 8); outerHigh.forEach((p, i) => p.target = [0,3,4,7].includes(i) ? 'solar' : 'helipad');
            const midHigh = roster.splice(0, 6); midHigh.forEach((p, i) => p.target = [0,3,4].includes(i) ? 'dev' : 'munition');
            const wtGroup = roster.splice(0, 4); wtGroup.forEach((p, i) => p.target = i % 2 === 0 ? 'wt1' : 'wt2');
            const wpGroup = roster.splice(0, 8); const wpB = ['wp1', 'wp2', 'wp3', 'wp4']; wpGroup.forEach((p, i) => p.target = wpB[Math.floor(i / 2)]);
            roster.forEach(p => p.target = 'bench');
            return [...center, ...outerHigh, ...midHigh, ...wtGroup, ...wpGroup, ...roster, ...players.filter(p => p.status === 'bench').map(p => ({...p, target: 'bench'}))];
        }

        function computeTeamRoles(distributed) {
            const teams = {};
            distributed.filter(p => p.target && p.target !== 'bench').forEach(p => {
                if (!teams[p.target]) teams[p.target] = [];
                teams[p.target].push(p);
            });

            const captains = new Set();
            Object.keys(teams).forEach((teamId) => {
                if (teamId === 'center') return;
                const sorted = [...teams[teamId]].sort((a, b) => b.tacticalRank - a.tacticalRank);
                if (sorted[0]) captains.add(String(sorted[0].id));
            });

            const jokers = new Set();
            const allSorted = [...distributed].sort((a, b) => b.tacticalRank - a.tacticalRank);
            if (allSorted[2]) jokers.add(String(allSorted[2].id));
            if (allSorted[3]) jokers.add(String(allSorted[3].id));

            const solarSorted = (teams['solar'] || []).slice().sort((a, b) => b.tacticalRank - a.tacticalRank);
            const helipadSorted = (teams['helipad'] || []).slice().sort((a, b) => b.tacticalRank - a.tacticalRank);
            if (solarSorted[1]) jokers.add(String(solarSorted[1].id));
            if (helipadSorted[1]) jokers.add(String(helipadSorted[1].id));

            const teamMembers = {};
            Object.keys(teams).forEach((teamId) => {
                teamMembers[teamId] = teams[teamId].map(p => p.name).filter(Boolean);
            });

            return { captains, jokers, teamMembers };
        }

        function renderMap() {
            const root = document.getElementById('map-root');
            root.innerHTML = '';
            const distributed = calculateDistribution();
            const roles = computeTeamRoles(distributed);

            BUILDING_CONFIG.forEach(config => {
                const el = document.createElement('div');
                el.className = 'building'; el.style.left = `${config.x}%`; el.style.top = `${config.y}%`;
                if (config.icon) {
                    const img = document.createElement('img');
                    img.src = `${ICON_BASE_URL}${config.icon}`;
                    img.className = 'building-img';
                    img.style.width = (config.imgSize || 80) + 'px';
                    img.style.height = (config.imgSize || 80) + 'px';
                    el.appendChild(img);
                }
                const label = document.createElement('div'); 
                label.className = 'building-label';
                if(config.labelScale) label.style.transform = `scale(${config.labelScale})`;
                label.innerHTML = `<span>${t(config.nameKey) + (config.nameSuffix || '')}</span>`;
                el.appendChild(label);

                const assigned = distributed.filter(p => p.target === config.id);
                let showing = [];

                if (currentPhase === 1) {
                    if (!['center', 'dev', 'munition'].includes(config.id)) {
                        showing = assigned.map(p => ({...p, moving: false}));
                        const centerTeam = distributed.filter(p => p.target === 'center');
                        if (config.id === 'solar' && centerTeam.length >= 3) showing.push({...centerTeam[0], moving: true}, {...centerTeam[2], moving: true});
                        if (config.id === 'helipad' && centerTeam.length >= 4) showing.push({...centerTeam[1], moving: true}, {...centerTeam[3], moving: true});
                        if (config.id === 'wt1') showing.push(...distributed.filter(p => p.target === 'dev').map(p => ({...p, moving: true})));
                        if (config.id === 'wt2') showing.push(...distributed.filter(p => p.target === 'munition').map(p => ({...p, moving: true})));
                    }
                } else showing = assigned.map(p => ({...p, moving: false}));

                showing.forEach(p => {
                    const bubble = document.createElement('div');
                    const isJoker = roles.jokers.has(String(p.id));
                    const isCaptain = roles.captains.has(String(p.id));
                    const isMatch = searchSelectedId && String(p.id) === String(searchSelectedId);
                    let c = 'color-default';
                    if (p.target === 'center') c = 'color-center';
                    else if (p.target === 'dev') c = 'color-dev';
                    else if (p.target === 'munition') c = 'color-munition';
                    bubble.className = `player-bubble ${c} ${isJoker ? 'joker' : ''} ${isMatch ? 'search-highlight' : ''}`;
                    const roleIcons = `${isCaptain ? '&#11088; ' : ''}${isJoker ? '&#127183; ' : ''}`;
                    bubble.innerHTML = `<span>${roleIcons}${p.name}</span>`;
                    if (isAdmin) bubble.onclick = (e) => { e.stopPropagation(); openReplaceModal(p); };
                    el.appendChild(bubble);
                });
                root.appendChild(el);
            });
        }

        // --- ADMIN ---
        window.openAdminModal = () => document.getElementById('admin-login-modal').classList.remove('hidden');
        window.closeAdminModal = () => document.getElementById('admin-login-modal').classList.add('hidden');
        window.checkAdminPass = () => {
            if (document.getElementById('admin-pass-input').value === "alliance123") {
                isAdmin = true; document.getElementById('admin-toggle').classList.remove('hidden'); document.body.classList.add('admin-mode'); renderMap(); closeAdminModal();
            } else alert("Wrong password.");
        };
        window.setView = (v) => {
            document.getElementById('view-map').classList.toggle('hidden', v !== 'map'); document.getElementById('view-admin').classList.toggle('hidden', v !== 'admin');
            document.getElementById('btn-view-map').className = v === 'map' ? 'px-6 py-2 rounded-xl text-xs font-black btn-active' : 'px-6 py-2 rounded-xl text-xs font-black btn-inactive';
            document.getElementById('btn-view-admin').className = v === 'admin' ? 'px-6 py-2 rounded-xl text-xs font-black btn-active' : 'px-6 py-2 rounded-xl text-xs font-black btn-inactive';
            if (v === 'admin') renderAdmin();
        };
        window.processPlayers = () => {
            const input = document.getElementById('player-input').value;
            const now = Date.now();
            const rows = input.split('\n').filter(l => l.includes(','));
            const incoming = [];
            const seen = new Set();
            rows.forEach((line) => {
                const parts = line.split(',');
                const name = (parts[0] || '').trim();
                const pow = parseInt((parts[1] || '').trim());
                if (!name || Number.isNaN(pow)) return;
                const key = name.toLowerCase();
                if (seen.has(key)) return;
                seen.add(key);
                incoming.push({ name, power: pow });
            });

            if (incoming.length === 0) return;

            const existing = new Map(players.map(p => [(p.name || '').toLowerCase(), p]));
            const updated = new Set();
            const result = [];
            const teamLimit = 30;

            incoming.forEach((entry, idx) => {
                const key = entry.name.toLowerCase();
                const prev = existing.get(key);
                const status = idx < teamLimit ? 'team' : 'bench';
                const base = prev ? {...prev} : { id: Date.now() + Math.random() };
                result.push({
                    ...base,
                    name: entry.name,
                    power: entry.power,
                    tacticalRank: entry.power,
                    status,
                    updatedAt: now + idx
                });
                updated.add(key);
            });

            players.forEach(p => {
                const key = (p.name || '').toLowerCase();
                if (updated.has(key)) return;
                result.push({
                    ...p,
                    status: 'off'
                });
            });

            players = result;
            saveData();
            renderAdmin();
            renderMap();
            alert("Roster Updated!");
        };
        window.exportData = () => {
            saveData();
            const saved = localStorage.getItem('res_raid_static_data_v1');
            const data = saved ? JSON.parse(saved) : players;
            const cleaned = data.map(({ target, moving, ...rest }) => rest);
            const code = `const INITIAL_DATA = ${JSON.stringify(cleaned)};`;
            navigator.clipboard.writeText(code); alert("Code copied!");
        };
        function saveData() { localStorage.setItem('res_raid_static_data_v1', JSON.stringify(players)); }
        window.setPlayerStatus = (id, s) => {
            const now = Date.now();
            players = players.map(p => String(p.id) === String(id) ? {...p, status: s, updatedAt: now} : p);
            saveData();
            renderAdmin();
            renderMap();
        };
        window.clearAll = () => { if(confirm("Clear?")) { players = []; saveData(); renderAdmin(); renderMap(); } };
        function renderAdmin() {
            const list = document.getElementById('roster-list'); list.innerHTML = '';
            const sorted = sortPlayers(players, getSortMode());
            sorted.forEach(p => {
                const row = document.createElement('div'); row.className = "bg-white p-3 rounded-xl border border-slate-100 mb-2 flex justify-between items-center";
                row.innerHTML = `<div><div class="font-bold text-xs">${p.name}</div><div class="text-[9px] text-slate-400">${p.power.toLocaleString()}</div></div><div class="flex gap-1"><button onclick="setPlayerStatus('${p.id}', 'team')" class="px-2 py-1 text-[8px] font-bold rounded ${p.status==='team'?'bg-indigo-600 text-white':'bg-slate-100'}">TEAM</button><button onclick="setPlayerStatus('${p.id}', 'bench')" class="px-2 py-1 text-[8px] font-bold rounded ${p.status==='bench'?'bg-amber-500 text-white':'bg-slate-100'}">BENCH</button></div>`;
                list.appendChild(row);
            });
        }

        // --- REPLACE LOGIC ---
        window.openReplaceModal = (p) => {
            replaceSourceId = p.id;
            document.getElementById('replace-target').innerText = p.name;
            document.getElementById('modal-menu').classList.remove('hidden');
            document.getElementById('bench-options').classList.add('hidden');
            setModalSortVisible(false);
            modalActiveView = "";
            document.getElementById('replace-modal').classList.remove('hidden');
            document.getElementById('replace-modal').classList.add('flex');
        };

        window.closeReplaceModal = () => {
            document.getElementById('replace-modal').classList.add('hidden');
            document.getElementById('replace-modal').classList.remove('flex');
            setModalSortVisible(false);
            modalActiveView = "";
        };

        window.showSwapList = () => {
            document.getElementById('modal-menu').classList.add('hidden');
            const options = document.getElementById('bench-options');
            options.innerHTML = ''; options.classList.remove('hidden');
            modalActiveView = "swap";
            setModalSortVisible(true);
            const modalSelect = document.getElementById('modal-sort');
            if (modalSelect) modalSelect.value = getSortMode();
            let pool = players.filter(p => p.status === 'team' && String(p.id) !== String(replaceSourceId));
            pool = sortPlayers(pool, getSortMode());
            pool.forEach(target => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-slate-50 hover:bg-indigo-50 p-4 rounded-2xl flex justify-between border border-slate-100 mb-2 font-bold text-slate-700";
                btn.innerHTML = `<span>${target.name}</span> <span class="text-indigo-400 text-[10px] uppercase">${target.power.toLocaleString()}</span>`;
                btn.onclick = () => performReplace(target.id);
                options.appendChild(btn);
            });
        };

        window.showReplaceWithBench = () => {
            document.getElementById('modal-menu').classList.add('hidden');
            const options = document.getElementById('bench-options');
            options.innerHTML = ''; options.classList.remove('hidden');
            modalActiveView = "bench";
            setModalSortVisible(true);
            const modalSelect = document.getElementById('modal-sort');
            if (modalSelect) modalSelect.value = getSortMode();
            let pool = players.filter(p => p.status === 'bench');
            pool = sortPlayers(pool, getSortMode());
            pool.forEach(res => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-slate-50 hover:bg-amber-50 p-4 rounded-2xl flex justify-between border border-slate-100 mb-2 font-bold text-slate-700";
                btn.innerHTML = `<span>${res.name}</span> <span class="text-amber-600 font-mono text-[10px]">${res.power.toLocaleString()}</span>`;
                btn.onclick = () => performReplace(res.id);
                options.appendChild(btn);
            });
        };

        window.performReplace = (targetId) => {
            const sIdx = players.findIndex(p => String(p.id) === String(replaceSourceId));
            const tIdx = players.findIndex(p => String(p.id) === String(targetId));
            if (sIdx > -1 && tIdx > -1) {
                const now = Date.now();
                const sRank = players[sIdx].tacticalRank;
                const sStatus = players[sIdx].status;
                const tRank = players[tIdx].tacticalRank;
                const tStatus = players[tIdx].status;
                players[sIdx].tacticalRank = tRank;
                players[sIdx].status = tStatus;
                players[sIdx].updatedAt = now;
                players[tIdx].tacticalRank = sRank;
                players[tIdx].status = sStatus;
                players[tIdx].updatedAt = now;
                saveData(); renderMap(); renderAdmin(); closeReplaceModal();
            }
        };

        window.moveCurrentToBench = () => { setPlayerStatus(replaceSourceId, 'bench'); closeReplaceModal(); };
        document.getElementById('admin-pass-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') checkAdminPass(); });
    </script>
</body>
</html>
